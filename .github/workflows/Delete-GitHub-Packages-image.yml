name: Delete unwanted GitHub Packages image

on:
  workflow_dispatch:

jobs:
  delete-package:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: Delete miget package
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const packageName = "miget";   // 改成 migetus 就能删另一个
            const packageType = "container";

            const versions = await github.paginate(
              github.rest.packages.getAllPackageVersionsForPackageOwnedByUser,
              {
                username: owner,
                package_type: packageType,
                package_name: packageName,
                per_page: 100,
              }
            );

            console.log(`Found ${versions.length} versions`);

            if (versions.length === 1) {
              console.log("Only one version left, deleting entire package...");

              await github.rest.packages.deletePackageForUser({
                username: owner,
                package_type: packageType,
                package_name: packageName,
              });

              console.log("Package deleted successfully.");
              return;
            }

            for (const v of versions) {
              console.log(`Deleting version ${v.id}`);
              await github.rest.packages.deletePackageVersionForUser({
                username: owner,
                package_type: packageType,
                package_name: packageName,
                package_version_id: v.id,
              });
            }

            console.log("All versions deleted.");